<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Potential Matches</title>
		<style>
			:root {
				color-scheme: light;
				--bg: #f7f7f5;
				--surface: #ffffff;
				--ink: #1d1d1f;
				--muted: #86868b;
				--border: #e5e5ea;
				--accent: #1d4ed8;
				--accent-soft: #eff3ff;
			}

			* {
				box-sizing: border-box;
			}

			body {
				margin: 0;
				font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
				background: var(--bg);
				color: var(--ink);
			}

			.app {
				padding: 16px 0 16px 16px;
			}

			/* Header */
			.header {
				display: flex;
				align-items: center;
				gap: 8px;
				margin-bottom: 12px;
				padding-right: 16px;
			}

			.header h1 {
				margin: 0;
				font-size: 15px;
				font-weight: 600;
				letter-spacing: -0.01em;
			}

			.count {
				font-size: 12px;
				color: var(--muted);
				font-weight: 500;
			}

			/* Horizontal scroll track */
			.scroll-track {
				display: flex;
				gap: 12px;
				overflow-x: auto;
				scroll-snap-type: x mandatory;
				-webkit-overflow-scrolling: touch;
				padding-bottom: 4px;
				padding-right: 16px;
			}

			.scroll-track::-webkit-scrollbar {
				display: none;
			}

			/* Match card */
			.match-card {
				flex: 0 0 180px;
				scroll-snap-align: start;
				background: var(--surface);
				border: 1px solid var(--border);
				border-radius: 14px;
				overflow: hidden;
				display: flex;
				flex-direction: column;
			}

			/* Blurred photo area */
			.photo-area {
				position: relative;
				height: 100px;
				overflow: hidden;
				display: grid;
				place-items: center;
			}

			.photo-blur {
				position: absolute;
				inset: -20px;
				filter: blur(18px);
			}

			.photo-label {
				position: relative;
				z-index: 1;
				font-size: 9px;
				font-weight: 600;
				color: rgba(0, 0, 0, 0.5);
				text-transform: uppercase;
				letter-spacing: 0.1em;
				background: rgba(255, 255, 255, 0.65);
				padding: 3px 8px;
				border-radius: 999px;
				backdrop-filter: blur(4px);
			}

			/* Card body */
			.card-body {
				padding: 10px 12px 12px;
				display: flex;
				flex-direction: column;
				gap: 4px;
				flex: 1;
			}

			.card-name {
				font-size: 14px;
				font-weight: 700;
				line-height: 1.2;
			}

			.card-meta {
				font-size: 12px;
				color: var(--muted);
				line-height: 1.3;
			}

			.card-score {
				font-size: 11px;
				font-weight: 600;
				color: var(--accent);
				margin-top: 2px;
			}

			.card-reasons {
				display: flex;
				flex-wrap: wrap;
				gap: 4px;
				margin-top: 4px;
			}

			.reason {
				font-size: 10px;
				background: var(--accent-soft);
				color: var(--accent);
				padding: 2px 6px;
				border-radius: 999px;
				white-space: nowrap;
				font-weight: 500;
			}

			/* Empty state */
			.empty {
				padding: 24px 16px;
				text-align: center;
				color: var(--muted);
				font-size: 13px;
			}

			/* Debug log (hidden by default, enable via console) */
			.debug {
				display: none;
				padding: 8px 16px;
				font-size: 10px;
				font-family: monospace;
				color: var(--muted);
				max-height: 120px;
				overflow-y: auto;
				white-space: pre-wrap;
				word-break: break-all;
			}
		</style>
	</head>
	<body>
		<div class="app">
			<div id="root">
				<div class="empty">Waiting for match results...</div>
			</div>
			<div class="debug" id="debug"></div>
		</div>

		<script>
			/* Color palette for blurred photo backgrounds */
			const GRADIENTS = [
				'linear-gradient(135deg, #a2c4ff 0%, #ffd6a5 100%)',
				'linear-gradient(135deg, #bdb2ff 0%, #ffc6ff 100%)',
				'linear-gradient(135deg, #caffbf 0%, #9bf6ff 100%)',
				'linear-gradient(135deg, #ffd6a5 0%, #ff9e9e 100%)',
				'linear-gradient(135deg, #a0e7e5 0%, #b4f8c8 100%)',
				'linear-gradient(135deg, #ddd6fe 0%, #fecaca 100%)',
			];

			const state = {
				matches: [],
			};

			let debugEl = document.getElementById('debug');

			function log(msg) {
				if (debugEl) {
					debugEl.textContent += msg + '\n';
					debugEl.scrollTop = debugEl.scrollHeight;
				}
				console.log('[MatchUI]', msg);
			}

			function maskName(name) {
				if (!name) return 'Single';
				return name
					.split(/\s+/)
					.filter(Boolean)
					.map(p => (p.length <= 1 ? '*' : p[0].toUpperCase() + '*'.repeat(p.length - 1)))
					.join(' ');
			}

			function maskAge(age) {
				if (!age || !Number.isFinite(age)) return null;
				return `${Math.floor(age / 10) * 10}s`;
			}

			function formatScore(score) {
				if (score === null || score === undefined) return null;
				if (score > 1) return `${Math.round(score)}%`;
				return `${Math.round(score * 100)}%`;
			}

			function render() {
				const root = document.getElementById('root');
				if (!root) return;

				if (!state.matches.length) {
					root.innerHTML = '<div class="empty">Waiting for match results...</div>';
					return;
				}

				const cards = state.matches.map((match, i) => {
					/* Use pre-masked data if available, otherwise mask client-side */
					const masked = match.masked || {};
					const name = masked.name || maskName(match.person?.name);
					const age = masked.age || maskAge(match.person?.age);
					const location = masked.location || 'Location hidden';
					const score = formatScore(match.compatibility_score);
					const reasons = (match.match_reasons || []).slice(0, 2);
					const grad = GRADIENTS[i % GRADIENTS.length];

					const metaParts = [age, location].filter(Boolean).join(' \u00B7 ');

					const reasonsHtml = reasons.length
						? `<div class="card-reasons">${reasons.map(r => `<span class="reason">${r}</span>`).join('')}</div>`
						: '';

					const scoreHtml = score
						? `<div class="card-score">${score} match</div>`
						: '';

					return `
						<div class="match-card">
							<div class="photo-area">
								<div class="photo-blur" style="background: ${grad}"></div>
								<span class="photo-label">Photo hidden</span>
							</div>
							<div class="card-body">
								<div class="card-name">${name}</div>
								<div class="card-meta">${metaParts}</div>
								${scoreHtml}
								${reasonsHtml}
							</div>
						</div>
					`;
				}).join('');

				root.innerHTML = `
					<div class="header">
						<h1>Potential Matches</h1>
						<span class="count">${state.matches.length} found</span>
					</div>
					<div class="scroll-track">${cards}</div>
				`;
			}

			function handleMessage(event) {
				if (event.source !== window.parent) return;
				const msg = event.data;
				if (!msg || typeof msg !== 'object') return;

				log('msg: ' + msg.method);

				if (msg.method === 'ui/notifications/tool-result') {
					const params = msg.params || {};
					const sc = params.structuredContent;

					log('structuredContent: ' + JSON.stringify(sc)?.substring(0, 200));

					if (sc && sc.matches && Array.isArray(sc.matches)) {
						state.matches = sc.matches;
						render();
					}
				}

				if (msg.method === 'ui/initialize') {
					log('initialized');
				}
			}

			window.addEventListener('message', handleMessage, { passive: true });
			render();
		</script>
	</body>
</html>
