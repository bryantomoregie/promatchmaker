<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Matchmaker Discovery</title>
		<style>
			:root {
				color-scheme: light;
				--bg: #f7f7f5;
				--surface: #ffffff;
				--ink: #1d1d1f;
				--muted: #6b6b6f;
				--border: #e3e3e8;
				--accent: #1d4ed8;
				--accent-soft: #e8efff;
				--warn: #9f1239;
			}

			* {
				box-sizing: border-box;
			}

			body {
				margin: 0;
				font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
				background: var(--bg);
				color: var(--ink);
			}

			.app {
				padding: 20px;
				display: grid;
				gap: 16px;
			}

			.header {
				display: flex;
				align-items: center;
				justify-content: space-between;
			}

			.header h1 {
				margin: 0;
				font-size: 18px;
				letter-spacing: 0.02em;
			}

			.badge {
				font-size: 12px;
				padding: 4px 10px;
				border-radius: 999px;
				background: var(--accent-soft);
				color: var(--accent);
				font-weight: 600;
			}

			.grid {
				display: grid;
				gap: 16px;
				grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
			}

			.card {
				background: var(--surface);
				border: 1px solid var(--border);
				border-radius: 16px;
				padding: 16px;
				box-shadow: 0 10px 24px rgba(0, 0, 0, 0.04);
			}

			.card h2 {
				margin: 0 0 8px 0;
				font-size: 16px;
			}

			.card p {
				margin: 4px 0;
				font-size: 14px;
				color: var(--muted);
			}

			.single-name {
				font-size: 20px;
				font-weight: 700;
				color: var(--ink);
				margin-bottom: 8px;
			}

			.single-fields {
				display: grid;
				gap: 6px;
				font-size: 14px;
			}

			.label {
				color: var(--muted);
				font-weight: 600;
				margin-right: 6px;
			}

			.empty {
				padding: 12px;
				border: 1px dashed var(--border);
				border-radius: 12px;
				color: var(--muted);
				font-size: 14px;
			}

			.matches {
				display: grid;
				gap: 12px;
			}

			.match-card {
				display: grid;
				grid-template-columns: 64px 1fr;
				gap: 12px;
				align-items: center;
				border: 1px solid var(--border);
				border-radius: 12px;
				padding: 12px;
			}

			.blur-photo {
				position: relative;
				width: 64px;
				height: 64px;
				border-radius: 16px;
				overflow: hidden;
				background: #d9d9df;
				display: grid;
				place-items: center;
			}

			.blur-photo__img {
				position: absolute;
				inset: -10px;
				background: linear-gradient(120deg, #a2c4ff, #ffd6a5, #bdb2ff);
				filter: blur(10px);
			}

			.blur-photo__label {
				position: relative;
				z-index: 1;
				font-size: 10px;
				color: #1f2937;
				text-transform: uppercase;
				letter-spacing: 0.08em;
				background: rgba(255, 255, 255, 0.7);
				padding: 2px 6px;
				border-radius: 999px;
			}

			.match-info {
				display: grid;
				gap: 4px;
			}

			.match-title {
				font-weight: 700;
				font-size: 15px;
			}

			.match-meta {
				font-size: 13px;
				color: var(--muted);
			}

			.reasons {
				display: flex;
				flex-wrap: wrap;
				gap: 6px;
				margin-top: 6px;
			}

			.reason-pill {
				font-size: 11px;
				background: #f0f1f4;
				color: #374151;
				padding: 4px 8px;
				border-radius: 999px;
			}

			.footer {
				font-size: 12px;
				color: var(--muted);
				text-align: right;
			}
		</style>
	</head>
	<body>
		<div class="app">
			<div class="header">
				<h1>Discovery Workspace</h1>
				<span class="badge">ChatGPT Discovery</span>
			</div>

			<div class="grid">
				<section class="card" id="single-card">
					<h2>Single Being Added</h2>
					<div class="empty">No single captured yet. Add a name to begin.</div>
				</section>

				<section class="card" id="matches-card">
					<h2>Suggested Singles</h2>
					<div class="empty">Run matching to preview masked suggestions.</div>
				</section>
			</div>

			<div class="footer" id="status">Waiting for tool results.</div>
		</div>

		<script>
			const state = {
				single: null,
				matches: [],
				lastUpdated: null,
			};

			function maskName(name) {
				if (!name) return 'Single';
				return name
					.split(/\s+/)
					.filter(Boolean)
					.map(part => {
						if (part.length <= 1) return '*';
						return part[0].toUpperCase() + '*'.repeat(part.length - 1);
					})
					.join(' ');
			}

			function maskAge(age) {
				if (!age || !Number.isFinite(age)) return 'Age hidden';
				return `${Math.floor(age / 10) * 10}s`;
			}

			function maskLocation(location) {
				return location ? 'Location hidden' : 'Location hidden';
			}

			function setStatus(text) {
				const status = document.getElementById('status');
				if (status) status.textContent = text;
			}

			function renderSingle() {
				const card = document.getElementById('single-card');
				if (!card) return;

				if (!state.single) {
					card.innerHTML = `
						<h2>Single Being Added</h2>
						<div class="empty">No single captured yet. Add a name to begin.</div>
					`;
					return;
				}

				const single = state.single;
				const prefs = single.preferences || {};
				const personality = single.personality || {};

				card.innerHTML = `
					<h2>Single Being Added</h2>
					<div class="single-name">${single.name || 'Unnamed Single'}</div>
					<div class="single-fields">
						<div><span class="label">Age:</span>${single.age ?? 'Unknown'}</div>
						<div><span class="label">Location:</span>${single.location ?? 'Unknown'}</div>
						<div><span class="label">Gender:</span>${single.gender ?? 'Unknown'}</div>
						<div><span class="label">Preferences:</span>${formatPreferences(prefs)}</div>
						<div><span class="label">Personality:</span>${formatPersonality(personality)}</div>
						<div><span class="label">Notes:</span>${single.notes ?? 'None yet'}</div>
					</div>
				`;
			}

			function renderMatches() {
				const card = document.getElementById('matches-card');
				if (!card) return;

				if (!state.matches || state.matches.length === 0) {
					card.innerHTML = `
						<h2>Suggested Singles</h2>
						<div class="empty">Run matching to preview masked suggestions.</div>
					`;
					return;
				}

				const matchItems = state.matches
					.map(match => {
						const masked = match.masked || {
							name: maskName(match.person?.name),
							age: maskAge(match.person?.age),
							location: maskLocation(match.person?.location),
						};
						const reasons = (match.match_reasons || [])
							.slice(0, 3)
							.map(reason => `<span class="reason-pill">${reason}</span>`)
							.join('');

						return `
							<div class="match-card">
								<div class="blur-photo" aria-label="Blurred photo">
									<div class="blur-photo__img"></div>
									<div class="blur-photo__label">Masked</div>
								</div>
								<div class="match-info">
									<div class="match-title">${masked.name}</div>
									<div class="match-meta">${masked.age} · ${masked.location}</div>
									<div class="match-meta">Compatibility: ${formatScore(match.compatibility_score)}</div>
									<div class="reasons">${reasons}</div>
								</div>
							</div>
						`;
					})
					.join('');

				card.innerHTML = `
					<h2>Suggested Singles</h2>
					<div class="matches">${matchItems}</div>
				`;
			}

			function formatScore(score) {
				if (score === null || score === undefined) return 'N/A';
				if (score > 1) return `${score}%`;
				return `${Math.round(score * 100)}%`;
			}

			function formatPreferences(prefs) {
				const parts = [];
				if (prefs.ageRange) {
					const min = prefs.ageRange.min ?? '?';
					const max = prefs.ageRange.max ?? '?';
					parts.push(`Age ${min}-${max}`);
				}
				if (Array.isArray(prefs.locations) && prefs.locations.length) {
					parts.push(`Locations: ${prefs.locations.join(', ')}`);
				}
				if (Array.isArray(prefs.genders) && prefs.genders.length) {
					parts.push(`Genders: ${prefs.genders.join(', ')}`);
				}
				return parts.length ? parts.join(' · ') : 'Not captured yet';
			}

			function formatPersonality(personality) {
				const parts = [];
				if (Array.isArray(personality.traits) && personality.traits.length) {
					parts.push(`Traits: ${personality.traits.join(', ')}`);
				}
				if (Array.isArray(personality.interests) && personality.interests.length) {
					parts.push(`Interests: ${personality.interests.join(', ')}`);
				}
				return parts.length ? parts.join(' · ') : 'Not captured yet';
			}

			function render() {
				renderSingle();
				renderMatches();
				if (state.lastUpdated) {
					setStatus(`Last updated ${state.lastUpdated.toLocaleTimeString()}`);
				}
			}

			function handleStructuredContent(structuredContent) {
				if (!structuredContent) return;

				if (structuredContent.single) {
					state.single = structuredContent.single;
				}

				if (structuredContent.matches) {
					state.matches = structuredContent.matches;
				}

				state.lastUpdated = new Date();
				render();
			}

			function handleToolResult(params) {
				if (!params) return;
				if (params.structuredContent) {
					handleStructuredContent(params.structuredContent);
				}
			}

			window.addEventListener('message', event => {
				if (event.source !== window.parent) return;
				const data = event.data || {};
				if (data.method === 'ui/notifications/tool-result') {
					handleToolResult(data.params);
				}
				if (data.method === 'ui/initialize') {
					setStatus('Connected to ChatGPT');
				}
			});

			render();
		</script>
	</body>
</html>
