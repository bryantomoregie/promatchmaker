<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Potential Matches</title>
		<style>
			:root {
				color-scheme: light;
				--bg: #f7f7f5;
				--surface: #ffffff;
				--ink: #1d1d1f;
				--muted: #86868b;
				--border: #e5e5ea;
				--accent: #1d4ed8;
				--accent-soft: #eff3ff;
			}

			* { box-sizing: border-box; }

			body {
				margin: 0;
				font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
				background: var(--bg);
				color: var(--ink);
			}

			.app { padding: 12px 0 12px 16px; }

			/* Header */
			.header {
				display: flex;
				align-items: center;
				gap: 8px;
				margin-bottom: 10px;
				padding-right: 16px;
			}
			.header h1 { margin: 0; font-size: 15px; font-weight: 600; }
			.count { font-size: 12px; color: var(--muted); font-weight: 500; }

			/* Horizontal scroll */
			.scroll-track {
				display: flex;
				gap: 12px;
				overflow-x: auto;
				scroll-snap-type: x mandatory;
				-webkit-overflow-scrolling: touch;
				padding-bottom: 4px;
				padding-right: 16px;
				scrollbar-width: none;
			}
			.scroll-track::-webkit-scrollbar { display: none; }

			/* Card */
			.match-card {
				flex: 0 0 160px;
				scroll-snap-align: start;
				background: var(--surface);
				box-shadow: 0 1px 3px rgba(0,0,0,0.08);
				border-radius: 12px;
				overflow: hidden;
			}

			/* Avatar area */
			.avatar-area {
				height: 120px;
				position: relative;
				overflow: hidden;
				display: grid;
				place-items: center;
			}
			.avatar-area svg {
				position: absolute;
				inset: 0;
				width: 100%;
				height: 100%;
			}
			/* Card body */
			.card-body {
				padding: 10px 12px 12px;
				display: flex;
				flex-direction: column;
				gap: 3px;
			}
			.card-title {
				font-size: 14px;
				font-weight: 600;
				line-height: 1.2;
			}
			.card-meta {
				font-size: 12px;
				color: var(--muted);
				line-height: 1.3;
			}
			.card-reasons {
				display: flex;
				flex-wrap: wrap;
				gap: 4px;
				margin-top: 4px;
			}
			.reason {
				font-size: 10px;
				background: var(--accent-soft);
				color: var(--accent);
				padding: 2px 7px;
				border-radius: 999px;
				font-weight: 500;
				white-space: nowrap;
			}

			/* Empty state */
			.empty {
				padding: 24px 16px;
				text-align: center;
				color: var(--muted);
				font-size: 13px;
			}

			/* Status bar */
			.status-bar {
				display: flex;
				align-items: center;
				gap: 6px;
				padding: 6px 16px;
				font-size: 10px;
				color: var(--muted);
			}
			.status-dot {
				width: 6px;
				height: 6px;
				border-radius: 50%;
				background: #d1d5db;
			}
			.status-dot.ok { background: #22c55e; }

			/* Debug panel — visible during dev, set to display:none for prod */
			.debug {
				display: block;
				margin: 8px 16px 0 0;
				padding: 8px;
				font-size: 10px;
				font-family: monospace;
				color: var(--muted);
				background: rgba(0,0,0,0.03);
				border-radius: 8px;
				max-height: 100px;
				overflow-y: auto;
				white-space: pre-wrap;
				word-break: break-all;
			}
		</style>
	</head>
	<body>
		<div class="app">
			<div id="root">
				<div class="empty">Waiting for match results...</div>
			</div>
			<div class="status-bar">
				<div class="status-dot" id="status-dot"></div>
				<span id="status-text">Waiting for connection</span>
			</div>
			<div class="debug" id="debug"></div>
		</div>

		<script>
			/* ── State ── */
			const state = { matches: [] };
			let connected = false;

			/* ── Debug helpers ── */
			const debugEl = document.getElementById('debug');
			function log(msg) {
				if (debugEl) {
					debugEl.textContent += msg + '\n';
					debugEl.scrollTop = debugEl.scrollHeight;
				}
				console.log('[MatchUI]', msg);
			}

			function setStatus(text, ok) {
				const dot = document.getElementById('status-dot');
				const label = document.getElementById('status-text');
				if (dot) dot.className = ok ? 'status-dot ok' : 'status-dot';
				if (label) label.textContent = text;
			}

			/* ── Deterministic avatar SVG from ID hash ── */
			function hashCode(str) {
				let h = 0;
				for (let i = 0; i < str.length; i++) {
					h = ((h << 5) - h + str.charCodeAt(i)) | 0;
				}
				return Math.abs(h);
			}

			function generateAvatar(id, index) {
				const h = hashCode(id || String(index));
				const hue1 = h % 360;
				const hue2 = (hue1 + 35 + (h >> 8) % 50) % 360;
				const sat = 55 + (h >> 4) % 20;

				/* 3 blurred circles at pseudo-random positions */
				const cx1 = 30 + (h % 120), cy1 = 15 + (h >> 3) % 60;
				const cx2 = 60 + (h >> 5) % 60, cy2 = 30 + (h >> 7) % 40;
				const cx3 = 20 + (h >> 9) % 140, cy3 = 40 + (h >> 11) % 30;

				return `<svg viewBox="0 0 160 120" xmlns="http://www.w3.org/2000/svg">
					<defs><filter id="b${index}"><feGaussianBlur stdDeviation="18"/></filter></defs>
					<rect fill="hsl(${hue1},${sat}%,82%)" width="160" height="120"/>
					<g filter="url(#b${index})">
						<circle cx="${cx1}" cy="${cy1}" r="35" fill="hsl(${hue2},${sat}%,75%)" opacity="0.7"/>
						<circle cx="${cx2}" cy="${cy2}" r="28" fill="hsl(${hue1},${sat + 10}%,70%)" opacity="0.6"/>
						<circle cx="${cx3}" cy="${cy3}" r="22" fill="hsl(${(hue2 + 60) % 360},${sat}%,78%)" opacity="0.5"/>
					</g>
				</svg>`;
			}

			/* ── Render ── */
			function render() {
				const root = document.getElementById('root');
				if (!root) return;

				if (!state.matches.length) {
					root.innerHTML = '<div class="empty">Waiting for match results...</div>';
					return;
				}

				const cards = state.matches.map((match, i) => {
					const age = match.age || null;
					const gender = match.gender || null;
					const profession = match.profession || null;
					const city = match.city || null;
					const reasons = (match.match_reasons || []).slice(0, 2);
					const avatar = generateAvatar(match.id, i);

					/* Title: "30s · Female" */
					const titleParts = [age, gender].filter(Boolean);
					const title = titleParts.join(' \u00b7 ') || 'Profile incomplete';

					/* Metadata: profession + city (max 2 lines per spec) */
					let metaHtml = '';
					if (profession) metaHtml += `<div class="card-meta">${profession}</div>`;
					if (city) metaHtml += `<div class="card-meta">${city}</div>`;

					const reasonsHtml = reasons.length
						? `<div class="card-reasons">${reasons.map(r => `<span class="reason">${r}</span>`).join('')}</div>`
						: '';

					return `
						<div class="match-card">
							<div class="avatar-area">
								${avatar}
							</div>
							<div class="card-body">
								<div class="card-title">${title}</div>
								${metaHtml}
								${reasonsHtml}
							</div>
						</div>
					`;
				}).join('');

				root.innerHTML = `
					<div class="header">
						<h1>Potential Matches</h1>
						<span class="count">${state.matches.length} found</span>
					</div>
					<div class="scroll-track">${cards}</div>
				`;
			}

			/* ── Message handler (MCP Apps protocol) ── */
			function handleMessage(event) {
				if (event.source !== window.parent) return;
				const msg = event.data;
				if (!msg || typeof msg !== 'object') return;

				log('recv: method=' + (msg.method || 'none') + ' id=' + (msg.id ?? 'none'));

				/* ── Handshake: respond to ui/initialize ── */
				if (msg.jsonrpc === '2.0' && msg.method === 'ui/initialize') {
					connected = true;
					setStatus('Connected', true);
					log('ui/initialize received, responding...');

					if (msg.id !== undefined) {
						window.parent.postMessage({
							jsonrpc: '2.0',
							id: msg.id,
							result: {}
						}, '*');
						log('handshake response sent for id=' + msg.id);
					}
					return;
				}

				/* ── Tool results ── */
				if (msg.method === 'ui/notifications/tool-result') {
					const params = msg.params || {};
					const sc = params.structuredContent;

					log('tool-result sc=' + JSON.stringify(sc)?.substring(0, 300));

					if (sc && sc.matches && Array.isArray(sc.matches)) {
						state.matches = sc.matches;
						setStatus('Data received — ' + sc.matches.length + ' matches', true);
						render();
						return;
					}

					log('no matches array in structuredContent');
				}
			}

			window.addEventListener('message', handleMessage, { passive: true });
			render();
			log('UI loaded, waiting for ui/initialize...');
		</script>
	</body>
</html>
