<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Match Carousel</title>
		<style>
			:root {
				color-scheme: light dark;
				--bg: #f7f7f5;
				--surface: #ffffff;
				--ink: #1d1d1f;
				--muted: #6b7280;
				--border: #e5e7eb;
				--accent: #1d4ed8;
				--accent-soft: rgba(29, 78, 216, 0.12);
				--shadow: 0 4px 18px rgba(15, 23, 42, 0.08);
			}

			@media (prefers-color-scheme: dark) {
				:root {
					--bg: #0f1115;
					--surface: #151821;
					--ink: #eef2ff;
					--muted: #9aa3b2;
					--border: #2a2f3a;
					--accent: #8ab4ff;
					--accent-soft: rgba(138, 180, 255, 0.18);
					--shadow: 0 8px 28px rgba(0, 0, 0, 0.35);
				}
			}

			* { box-sizing: border-box; }

			body {
				margin: 0;
				font-family: "SF Pro Text", "SF Pro Display", ui-sans-serif, system-ui, -apple-system, Segoe UI,
					Roboto, Helvetica, Arial, sans-serif;
				background: var(--bg);
				color: var(--ink);
			}

			.app {
				padding: 12px 0 14px 16px;
			}

			.header {
				display: flex;
				align-items: center;
				gap: 8px;
				margin-bottom: 10px;
				padding-right: 16px;
			}
			.header h1 {
				margin: 0;
				font-size: 14px;
				font-weight: 600;
			}
			.count {
				font-size: 12px;
				color: var(--muted);
				font-weight: 500;
			}

			.carousel-wrap {
				position: relative;
			}

			.carousel {
				display: flex;
				gap: 12px;
				overflow-x: auto;
				padding: 2px 16px 10px 0;
				scroll-snap-type: x mandatory;
				-webkit-overflow-scrolling: touch;
				touch-action: pan-x;
			}
			.carousel::-webkit-scrollbar { display: none; }
			.carousel { scrollbar-width: none; }

			.card {
				flex: 0 0 170px;
				scroll-snap-align: start;
				background: var(--surface);
				border: 1px solid var(--border);
				border-radius: 14px;
				box-shadow: var(--shadow);
				overflow: hidden;
				transition: transform 160ms ease, box-shadow 160ms ease;
			}
			.card:active {
				transform: translateY(1px) scale(0.99);
			}

			.hero {
				height: 120px;
				position: relative;
				overflow: hidden;
				background: linear-gradient(145deg, rgba(99,102,241,0.25), rgba(59,130,246,0.08));
			}
			.hero svg {
				position: absolute;
				inset: 0;
				width: 100%;
				height: 100%;
			}

			.body {
				padding: 10px 12px 12px;
				display: flex;
				flex-direction: column;
				gap: 4px;
			}
			.title {
				font-size: 14px;
				font-weight: 600;
				line-height: 1.2;
			}
			.meta {
				font-size: 12px;
				color: var(--muted);
				line-height: 1.3;
			}
			.tags {
				display: flex;
				flex-wrap: wrap;
				gap: 6px;
				margin-top: 4px;
			}
			.tag {
				font-size: 10px;
				background: var(--accent-soft);
				color: var(--accent);
				padding: 2px 7px;
				border-radius: 999px;
				font-weight: 600;
				white-space: nowrap;
			}

			.empty {
				padding: 20px 16px 14px;
				text-align: center;
				color: var(--muted);
				font-size: 13px;
			}

			.status-bar {
				display: flex;
				align-items: center;
				gap: 6px;
				padding: 6px 16px;
				font-size: 10px;
				color: var(--muted);
			}
			.status-dot {
				width: 6px;
				height: 6px;
				border-radius: 50%;
				background: #9ca3af;
			}
			.status-dot.ok { background: #22c55e; }

			.debug {
				display: block;
				margin: 8px 16px 0 0;
				padding: 8px;
				font-size: 10px;
				font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
				color: var(--muted);
				background: rgba(0,0,0,0.04);
				border-radius: 8px;
				max-height: 120px;
				overflow-y: auto;
				white-space: pre-wrap;
				word-break: break-all;
			}
		</style>
	</head>
	<body>
		<div class="app">
			<div id="root">
				<div class="empty">Waiting for match results...</div>
			</div>
			<div class="status-bar">
				<div class="status-dot" id="status-dot"></div>
				<span id="status-text">Waiting for connection</span>
			</div>
			<div class="debug" id="debug"></div>
		</div>

		<script>
			const state = { matches: [], receivedResults: false };

			const debugEl = document.getElementById('debug');
			function log(msg) {
				if (debugEl) {
					debugEl.textContent += msg + '\n';
					debugEl.scrollTop = debugEl.scrollHeight;
				}
				console.log('[MatchUI]', msg);
			}

			function setStatus(text, ok) {
				const dot = document.getElementById('status-dot');
				const label = document.getElementById('status-text');
				if (dot) dot.className = ok ? 'status-dot ok' : 'status-dot';
				if (label) label.textContent = text;
			}

			function hashCode(str) {
				let h = 0;
				for (let i = 0; i < str.length; i++) {
					h = ((h << 5) - h + str.charCodeAt(i)) | 0;
				}
				return Math.abs(h);
			}

			function generateAvatar(id, index) {
				const h = hashCode(id || String(index));
				const hue1 = h % 360;
				const hue2 = (hue1 + 35 + (h >> 8) % 50) % 360;
				const sat = 55 + (h >> 4) % 20;

				const cx1 = 30 + (h % 120), cy1 = 15 + (h >> 3) % 60;
				const cx2 = 60 + (h >> 5) % 60, cy2 = 30 + (h >> 7) % 40;
				const cx3 = 20 + (h >> 9) % 140, cy3 = 40 + (h >> 11) % 30;

				return `<svg viewBox="0 0 170 120" xmlns="http://www.w3.org/2000/svg">
					<defs><filter id="b${index}"><feGaussianBlur stdDeviation="18"/></filter></defs>
					<rect fill="hsl(${hue1},${sat}%,78%)" width="170" height="120"/>
					<g filter="url(#b${index})">
						<circle cx="${cx1}" cy="${cy1}" r="35" fill="hsl(${hue2},${sat}%,70%)" opacity="0.7"/>
						<circle cx="${cx2}" cy="${cy2}" r="28" fill="hsl(${hue1},${sat + 10}%,66%)" opacity="0.6"/>
						<circle cx="${cx3}" cy="${cy3}" r="22" fill="hsl(${(hue2 + 60) % 360},${sat}%,74%)" opacity="0.5"/>
					</g>
				</svg>`;
			}

			function render() {
				const root = document.getElementById('root');
				if (!root) return;

				if (!state.receivedResults) {
					root.innerHTML = '<div class="empty">Waiting for match results...</div>';
					return;
				}

				if (!state.matches.length) {
					root.innerHTML = '<div class="empty">No matches yet. Try again once more singles are added.</div>';
					return;
				}

				const cards = state.matches.map((match, i) => {
					const age = match.age || null;
					const gender = match.gender || null;
					const profession = match.profession || null;
					const city = match.city || null;
					const reasons = (match.match_reasons || []).slice(0, 2);
					const avatar = generateAvatar(match.id, i);

					const titleParts = [age, gender].filter(Boolean);
					const title = titleParts.join(' \u00b7 ') || 'Profile incomplete';

					let metaHtml = '';
					if (profession) metaHtml += `<div class="meta">${profession}</div>`;
					if (city) metaHtml += `<div class="meta">${city}</div>`;

					const reasonsHtml = reasons.length
						? `<div class="tags">${reasons.map(r => `<span class="tag">${r}</span>`).join('')}</div>`
						: '';

					return `
						<div class="card">
							<div class="hero">${avatar}</div>
							<div class="body">
								<div class="title">${title}</div>
								${metaHtml}
								${reasonsHtml}
							</div>
						</div>
					`;
				}).join('');

				root.innerHTML = `
					<div class="header">
						<h1>Potential Matches</h1>
						<span class="count">${state.matches.length} found</span>
					</div>
					<div class="carousel-wrap">
						<div class="carousel" aria-label="Match results carousel">${cards}</div>
					</div>
				`;
			}

			function handleMessage(event) {
				if (event.source !== window.parent) return;
				const msg = event.data;
				if (!msg || typeof msg !== 'object') return;

				log('recv: method=' + (msg.method || 'none') + ' id=' + (msg.id ?? 'none'));

				if (msg.jsonrpc === '2.0' && msg.method === 'ui/initialize') {
					setStatus('Connected', true);
					log('ui/initialize received, responding...');
					if (msg.id !== undefined) {
						window.parent.postMessage({ jsonrpc: '2.0', id: msg.id, result: {} }, '*');
						log('handshake response sent for id=' + msg.id);
					}
					return;
				}

				if (msg.method === 'ui/notifications/tool-input') {
					let toolName = msg.params?.toolName || 'unknown';
					setStatus(`Running ${toolName}...`, true);
					return;
				}

				if (msg.method === 'ui/notifications/tool-result') {
					const params = msg.params || {};
					const sc = params.structuredContent;

					log('tool-result sc=' + JSON.stringify(sc)?.substring(0, 300));

					state.receivedResults = true;

					if (sc && sc.matches && Array.isArray(sc.matches)) {
						state.matches = sc.matches;
						setStatus('Data received â€” ' + sc.matches.length + ' matches', true);
						render();
						return;
					}

					state.matches = [];
					setStatus('No matches in response', true);
					render();
				}
			}

			window.addEventListener('message', handleMessage, { passive: true });
			render();
			log('UI loaded, waiting for ui/initialize...');
		</script>
	</body>
</html>
